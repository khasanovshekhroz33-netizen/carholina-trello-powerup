<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Carholina OneClick</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9fafc; }
    h1 { color: #0a4d8c; }
    button { background: #0a4d8c; color: #fff; border: none; padding: 10px 16px; border-radius: 6px; margin: 4px; cursor: pointer; }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    button:hover { background: #06345d; }
    #log { margin-top: 16px; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; height: 240px; overflow: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Carholina ‚Äî One-Click Trello Board</h1>
  <p>1) –í–æ–π–¥–∏—Ç–µ –≤ Trello –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. 2) –ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª. 3) ¬´–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥–æ—Å–∫—É¬ª.</p>
  <p><b>–í–∞–∂–Ω–æ:</b> –≤ Trello ‚Üí API key –¥–æ–±–∞–≤—å—Ç–µ –≤ <i>Allowed origins</i>: <code id="origin"></code></p>

  <button id="authBtn">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
  <button id="createBtn" disabled>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥–æ—Å–∫—É</button>
  <button id="logoutBtn">–í—ã–π—Ç–∏ (—Å–±—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω)</button>
  <p id="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶</p>
  <div id="log">‚ÑπÔ∏è –õ–æ–≥ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>

<script>
  // === –ö–æ–Ω—Ñ–∏–≥ ===
  const API_KEY = "YOUR_TRELLO_API_KEY"; // –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
  const BOARD_JSON_URL = "https://khasanovshekhroz33-netizen.github.io/carholina-trello-powerup/Carholina_Trello_Board.json";

  // === –£—Ç–∏–ª–∏—Ç—ã UI ===
  const authBtn = document.getElementById("authBtn");
  const createBtn = document.getElementById("createBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const statusEl = document.getElementById("status");
  const logEl = document.getElementById("log");
  document.getElementById("origin").textContent = location.origin;

  const log = (m)=>{ logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };
  const setStatus = (m)=> statusEl.textContent = "–°—Ç–∞—Ç—É—Å: " + m;

  // === –¢–æ–∫–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ ===
  const TOKEN_KEY = "trello_token_carholina";
  const getToken = ()=> localStorage.getItem(TOKEN_KEY);
  const setToken = (t)=> localStorage.setItem(TOKEN_KEY, t);
  const clearToken = ()=> localStorage.removeItem(TOKEN_KEY);

  // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  function buildAuthorizeUrl() {
    const returnUrl = location.origin + location.pathname;
    const q = new URLSearchParams({
      expiration: "never",
      name: "CarholinaApp",
      scope: "read,write",
      response_type: "token",
      key: API_KEY,
      return_url: returnUrl
    });
    return "https://trello.com/1/authorize?" + q.toString();
  }
  function extractTokenFromHash() {
    const m = location.hash.match(/token=([^&]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }
  function scrubHash() {
    if (history.replaceState) history.replaceState(null, document.title, location.pathname + location.search);
    else location.hash = "";
  }

  // HTTP helper
  async function req(url, options) {
    const res = await fetch(url, options);
    let data = null; try { data = await res.json(); } catch(_) {}
    if (!res.ok) {
      const msg = (data && (data.message || data.error)) || (res.status + " " + res.statusText);
      throw new Error(msg);
    }
    return data;
  }

  // –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫
  async function createList(boardId, name, token) {
    return req(`https://api.trello.com/1/lists?name=${encodeURIComponent(name)}&idBoard=${boardId}&key=${API_KEY}&token=${token}`, { method:"POST" });
  }

  // –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
  async function createCard(listId, name, desc, token) {
    return req(`https://api.trello.com/1/cards?idList=${listId}&name=${encodeURIComponent(name)}&desc=${encodeURIComponent(desc||"")}&key=${API_KEY}&token=${token}`, { method:"POST" });
  }

  // –ß–µ–∫-–ª–∏—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ
  async function createChecklist(cardId, name, token) {
    return req(`https://api.trello.com/1/cards/${cardId}/checklists?name=${encodeURIComponent(name)}&key=${API_KEY}&token=${token}`, { method:"POST" });
  }
  async function addCheckItem(checklistId, name, token) {
    return req(`https://api.trello.com/1/checklists/${checklistId}/checkItems?name=${encodeURIComponent(name)}&key=${API_KEY}&token=${token}`, { method:"POST" });
  }

  // –°–æ–∑–¥–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç—ã –ø–æ JSON
  async function applyChecklists(cardId, checklists, token) {
    if (!checklists) return;
    for (const cl of checklists) {
      const clRes = await createChecklist(cardId, cl.name, token);
      for (const item of (cl.items||[])) {
        await addCheckItem(clRes.id, item, token);
      }
      log("    ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç: " + cl.name);
    }
  }

  // –°–æ–∑–¥–∞—Ç—å –¥–æ—á–µ—Ä–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∏—Ö –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é
  async function createSubcardsAndLink(parentCard, listId, subcards, token) {
    if (!subcards || !subcards.length) return;
    const linksChecklist = await createChecklist(parentCard.id, "–ü–æ–¥–∑–∞–¥–∞—á–∏ (—Å—Å—ã–ª–∫–∏)", token);
    for (const sc of subcards) {
      const child = await createCard(listId, sc.name, sc.desc || "", token);
      log("    üîó –î–æ—á–µ—Ä–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞: " + child.name);
      await applyChecklists(child.id, sc.checklists, token);
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ—á–µ—Ä–Ω—é—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ —á–µ–∫-–ª–∏—Å—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
      await addCheckItem(linksChecklist.id, child.url, token);
    }
  }

  // –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞
  async function createBoard() {
    const token = getToken();
    if (!token) { setStatus("–Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å"); return alert("–ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª"); }
    try {
      setStatus("–∑–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞"); log("üì• –ó–∞–≥—Ä—É–∂–∞–µ–º JSON‚Ä¶");
      const tpl = await (await fetch(BOARD_JSON_URL)).json();

      setStatus("—Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏"); log("‚è≥ –°–æ–∑–¥–∞—ë–º –¥–æ—Å–∫—É‚Ä¶");
      const board = await req(`https://api.trello.com/1/boards/?name=${encodeURIComponent(tpl.board.name)}&defaultLists=false&key=${API_KEY}&token=${token}`, { method:"POST" });
      log("‚úÖ –î–æ—Å–∫–∞: " + board.url);

      // –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–∫–∏ –∏ –Ω–∞–ø–æ–ª–Ω—è–µ–º
      for (const list of tpl.board.lists) {
        const listRes = await createList(board.id, list.name, token);
        log("‚ûï –°–ø–∏—Å–æ–∫: " + list.name);

        // –ö–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å–ø–∏—Å–∫–µ
        for (const card of (list.cards||[])) {
          const parent = await createCard(listRes.id, card.name, card.desc||"", token);
          log("  üìù –ö–∞—Ä—Ç–æ—á–∫–∞: " + card.name);
          await applyChecklists(parent.id, card.checklists, token);
          await createSubcardsAndLink(parent, listRes.id, card.subcards, token);
        }
      }

      setStatus("–≥–æ—Ç–æ–≤–æ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É"); log("üöÄ –û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É‚Ä¶");
      window.open(board.url, "_blank");
    } catch (e) {
      setStatus("–æ—à–∏–±–∫–∞"); log("‚ùå " + e.message); alert("–û—à–∏–±–∫–∞: " + e.message);
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  (function init(){
    const t = extractTokenFromHash();
    if (t) { setToken(t); scrubHash(); log("üîê –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω."); }
    if (getToken()) { createBtn.disabled = false; setStatus("–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –µ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å"); }
    authBtn.onclick = ()=> location.href = buildAuthorizeUrl();
    logoutBtn.onclick = ()=> { clearToken(); createBtn.disabled = true; setStatus("—Ç–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω"); };
    createBtn.onclick = createBoard;
  })();
</script>
</body>
</html>
