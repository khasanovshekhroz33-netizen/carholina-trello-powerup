<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Carholina OneClick Setup</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9fafc; }
    h1 { color: #0a4d8c; }
    button {
      background: #0a4d8c; color: white; border: none;
      padding: 12px 20px; border-radius: 6px;
      font-size: 16px; cursor: pointer; margin-right: 10px;
    }
    button:hover { background: #06345d; }
    #log {
      background: #fff; border: 1px solid #ccc;
      padding: 10px; margin-top: 20px;
      max-height: 200px; overflow-y: auto; white-space: pre-line;
    }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Carholina OneClick Setup</h1>
  <p>–ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª, –∑–∞—Ç–µ–º ¬´–°–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É¬ª. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).</p>

  <button id="authBtn">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
  <button id="createBtn" disabled>–°–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É Carholina</button>
  <button id="logoutBtn">–í—ã–π—Ç–∏ (—Å–±—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω)</button>

  <div id="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶</div>
  <pre id="log">‚ÑπÔ∏è –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</pre>

<script>
  // === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
  const API_KEY    = "f0459a9c4c84226e29b03e7d047b9dfb"; // –≤–∞—à API –∫–ª—é—á
  const BOARD_NAME = "Carholina MVP";
  const LISTS      = ["To Do", "In Progress", "Done", "Features"];
  const LABELS     = [{name:"–í –ø—É—Ç–∏", color:"blue"}, {name:"–ó–∞–≤–µ—Ä—à–µ–Ω–æ", color:"green"}];
  const CARDS      = [
    {name:"üöó –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞",list:"To Do",check:["–ü–æ–ª—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã","–ù–∞–∑–Ω–∞—á–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è","–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"]},
    {name:"üì¶ –í –ø—É—Ç–∏",list:"In Progress",label:"–í –ø—É—Ç–∏",check:["–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–∫–µ—Ä","–°–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º"]},
    {name:"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ",list:"Done",label:"–ó–∞–≤–µ—Ä—à–µ–Ω–æ",check:["–ó–∞–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑","–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç"]}
  ];

  const logEl     = document.getElementById("log");
  const statusEl  = document.getElementById("status");
  const authBtn   = document.getElementById("authBtn");
  const createBtn = document.getElementById("createBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const log = (msg) => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };
  const setStatus = (msg) => { statusEl.textContent = "–°—Ç–∞—Ç—É—Å: " + msg; };

  // === –†–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º ===
  const TOKEN_KEY = "trello_token_carholina";
  const getToken  = () => localStorage.getItem(TOKEN_KEY);
  const setToken  = (t) => localStorage.setItem(TOKEN_KEY, t);
  const clearToken= () => localStorage.removeItem(TOKEN_KEY);

  function extractTokenFromHash() {
    if (!location.hash) return null;
    const m = location.hash.match(/token=([^&]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }
  function scrubHash() {
    if (history.replaceState) {
      history.replaceState(null, document.title, location.pathname + location.search);
    } else {
      location.hash = "";
    }
  }
  function buildAuthorizeUrl() {
    const returnUrl = location.origin + location.pathname;
    const params = new URLSearchParams({
      expiration: "never", name: "CarholinaApp",
      scope: "read,write", response_type: "token",
      key: API_KEY, return_url: returnUrl
    });
    return `https://trello.com/1/authorize?${params.toString()}`;
  }
  function authorize() { location.href = buildAuthorizeUrl(); }
  function logout() {
    clearToken(); createBtn.disabled = true;
    setStatus("—Ç–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω; –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ");
    log("‚ÑπÔ∏è –¢–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω –∏–∑ localStorage.");
  }

  async function req(url, options) {
    const res = await fetch(url, options);
    let data = null; try { data = await res.json(); } catch(_) {}
    if (!res.ok) {
      const msg = data && (data.message || data.error) ? (data.message || data.error) : res.status + " " + res.statusText;
      throw new Error(msg);
    }
    return data;
  }

  // === –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏ –∏ –≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ ===
  async function createBoard() {
    const token = getToken();
    if (!token) { setStatus("–Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞"); log("‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å."); return; }

    try {
      setStatus("—Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏‚Ä¶"); log("‚è≥ –°–æ–∑–¥–∞—ë–º –¥–æ—Å–∫—É‚Ä¶");

      // 1) –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –¥–æ—Å–∫—É
      const board = await req(`https://api.trello.com/1/boards/?name=${encodeURIComponent(BOARD_NAME)}&defaultLists=false&key=${API_KEY}&token=${token}`, { method: "POST" });
      log("‚úÖ –î–æ—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: " + (board.url || board.id));

      // 2) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω
      await req(`https://api.trello.com/1/boards/${board.id}/prefs/background?value=blue&key=${API_KEY}&token=${token}`, { method: "PUT" });
      log("üé® –§–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: —Å–∏–Ω–∏–π Carholina");

      // 3) –°–ø–∏—Å–∫–∏
      let listsData = [];
      for (let listName of LISTS) {
        const list = await req(`https://api.trello.com/1/lists?name=${encodeURIComponent(listName)}&idBoard=${board.id}&key=${API_KEY}&token=${token}`, { method: "POST" });
        listsData.push(list);
        log("‚ûï –°–ø–∏—Å–æ–∫: " + listName);
      }

      // 4) –ú–µ—Ç–∫–∏
      let labelsData = {};
      for (let lbl of LABELS) {
        const lab = await req(`https://api.trello.com/1/labels?name=${encodeURIComponent(lbl.name)}&color=${lbl.color}&idBoard=${board.id}&key=${API_KEY}&token=${token}`, { method: "POST" });
        labelsData[lbl.name] = lab;
        log("üè∑ –ú–µ—Ç–∫–∞: " + lbl.name);
      }

      // 5) –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ—Å–∫–∏
      const members = await req(`https://api.trello.com/1/boards/${board.id}/members?key=${API_KEY}&token=${token}`);
      const me = members[0];

      // 6) –ö–∞—Ä—Ç–æ—á–∫–∏ + —á–µ–∫–ª–∏—Å—Ç—ã
      for (let c of CARDS) {
        const list = listsData.find(l => l.name === c.list);
        if (!list) continue;
        const label = c.label ? labelsData[c.label] : null;
        let cardUrl = `https://api.trello.com/1/cards?name=${encodeURIComponent(c.name)}&idList=${list.id}&idMembers=${me.id}&key=${API_KEY}&token=${token}`;
        if (label) cardUrl += `&idLabels=${label.id}`;
        const newCard = await req(cardUrl, { method: "POST" });
        log("üìù –ö–∞—Ä—Ç–æ—á–∫–∞: " + c.name + " (–Ω–∞–∑–Ω–∞—á–µ–Ω: " + me.fullName + ")");

        if (c.check && c.check.length) {
          const checklist = await req(`https://api.trello.com/1/cards/${newCard.id}/checklists?name=–ß–µ–∫–ª–∏—Å—Ç&key=${API_KEY}&token=${token}`, { method:"POST" });
          for (let item of c.check) {
            await req(`https://api.trello.com/1/checklists/${checklist.id}/checkItems?name=${encodeURIComponent(item)}&key=${API_KEY}&token=${token}`, { method:"POST" });
            log("   ‚òëÔ∏è " + item);
          }
        }
      }

      setStatus("–≥–æ—Ç–æ–≤–æ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É");
      log("üöÄ –û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É‚Ä¶");
      window.open(board.url, "_blank");

    } catch (err) {
      setStatus("–æ—à–∏–±–∫–∞"); log("‚ùå –û—à–∏–±–∫–∞: " + (err && err.message ? err.message : err));
      alert("–û—à–∏–±–∫–∞: " + (err && err.message ? err.message : err));
    }
  }

  // === Init ===
  (function init() {
    const tokenFromHash = extractTokenFromHash();
    if (tokenFromHash) { setToken(tokenFromHash); scrubHash(); log("üîê –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω."); }
    if (getToken()) { createBtn.disabled = false; setStatus("–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –µ—Å—Ç—å"); }
    else { createBtn.disabled = true; setStatus("–æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶"); }
    authBtn.addEventListener("click", authorize);
    createBtn.addEventListener("click", createBoard);
    logoutBtn.addEventListener("click", logout);
    log("‚ÑπÔ∏è –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –≤ Trello ‚ûú Allowed origins: " + location.origin);
  })();
</script>
</body>
</html>
