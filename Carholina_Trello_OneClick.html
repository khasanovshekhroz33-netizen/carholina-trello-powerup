<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Carholina OneClick</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f9fafc;
    }
    h1 { color: #0a4d8c; }
    button {
      background: #0a4d8c;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 6px;
    }
    button:hover { background: #06345d; }
    #log {
      margin-top: 20px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Carholina OneClick Setup</h1>
  <p>–ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª, –∑–∞—Ç–µ–º ¬´–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥–æ—Å–∫—É¬ª.</p>
  <button id="authBtn">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
  <button id="createBtn" disabled>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥–æ—Å–∫—É</button>
  <button id="logoutBtn">–í—ã–π—Ç–∏ (—Å–±—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω)</button>
  <p id="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶</p>
  <div id="log">‚ÑπÔ∏è –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>

  <script>
    const API_KEY = "f0459a9c4c84226e29b03e7d047b9dfb";
    const BOARD_JSON_URL = "https://khasanovshekhroz33-netizen.github.io/carholina-trello-powerup/Carholina_Trello_Board.json";

    const authBtn = document.getElementById("authBtn");
    const createBtn = document.getElementById("createBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");

    const log = (msg) => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };
    const setStatus = (msg) => { statusEl.textContent = "–°—Ç–∞—Ç—É—Å: " + msg; };

    const TOKEN_KEY = "trello_token_carholina";
    const getToken  = () => localStorage.getItem(TOKEN_KEY);
    const setToken  = (t) => localStorage.setItem(TOKEN_KEY, t);
    const clearToken= () => localStorage.removeItem(TOKEN_KEY);

    function extractTokenFromHash() {
      if (!location.hash) return null;
      const m = location.hash.match(/token=([^&]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    function scrubHash() {
      if (history.replaceState) {
        history.replaceState(null, document.title, location.pathname + location.search);
      } else {
        location.hash = "";
      }
    }

    function buildAuthorizeUrl() {
      const returnUrl = location.origin + location.pathname;
      const params = new URLSearchParams({
        expiration: "never",
        name: "CarholinaApp",
        scope: "read,write",
        response_type: "token",
        key: API_KEY,
        return_url: returnUrl
      });
      return `https://trello.com/1/authorize?${params.toString()}`;
    }

    function authorize() {
      location.href = buildAuthorizeUrl();
    }

    function logout() {
      clearToken();
      createBtn.disabled = true;
      setStatus("—Ç–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω; –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ");
      log("‚ÑπÔ∏è –¢–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω –∏–∑ localStorage.");
    }

    async function req(url, options) {
      const res = await fetch(url, options);
      let data = null;
      try { data = await res.json(); } catch(_) {}
      if (!res.ok) {
        const msg = data && (data.message || data.error) ? (data.message || data.error) : res.status + " " + res.statusText;
        throw new Error(msg);
      }
      return data;
    }

    async function createBoard() {
      const token = getToken();
      if (!token) {
        setStatus("–Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å");
        log("‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª.");
        return;
      }

      try {
        setStatus("–∑–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞‚Ä¶");
        log("üì• –ó–∞–≥—Ä—É–∂–∞–µ–º JSON —à–∞–±–ª–æ–Ω‚Ä¶");
        const templateRes = await fetch(BOARD_JSON_URL);
        const template = await templateRes.json();

        setStatus("—Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏‚Ä¶");
        log("‚è≥ –°–æ–∑–¥–∞—ë–º –¥–æ—Å–∫—É‚Ä¶");

        const createBoardUrl = `https://api.trello.com/1/boards/?name=${encodeURIComponent(template.board.name)}&defaultLists=false&key=${API_KEY}&token=${token}`;
        const board = await req(createBoardUrl, { method: "POST" });
        log("‚úÖ –î–æ—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: " + (board.url || board.id));

        for (const list of template.board.lists) {
          const createListUrl = `https://api.trello.com/1/lists?name=${encodeURIComponent(list.name)}&idBoard=${board.id}&key=${API_KEY}&token=${token}`;
          const listRes = await req(createListUrl, { method: "POST" });
          log("  ‚ûï –°–ø–∏—Å–æ–∫: " + list.name);

          if (list.cards) {
            for (const card of list.cards) {
              const createCardUrl = `https://api.trello.com/1/cards?idList=${listRes.id}&name=${encodeURIComponent(card.name)}&desc=${encodeURIComponent(card.desc || "")}&key=${API_KEY}&token=${token}`;
              const cardRes = await req(createCardUrl, { method: "POST" });
              log("    üìù –ö–∞—Ä—Ç–æ—á–∫–∞: " + card.name);

              if (card.checklists) {
                for (const checklist of card.checklists) {
                  const createChecklistUrl = `https://api.trello.com/1/cards/${cardRes.id}/checklists?name=${encodeURIComponent(checklist.name)}&key=${API_KEY}&token=${token}`;
                  const checklistRes = await req(createChecklistUrl, { method: "POST" });
                  for (const item of checklist.items) {
                    await req(`https://api.trello.com/1/checklists/${checklistRes.id}/checkItems?name=${encodeURIComponent(item)}&key=${API_KEY}&token=${token}`, { method: "POST" });
                  }
                  log("      ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç: " + checklist.name);
                }
              }
            }
          }
        }

        setStatus("–≥–æ—Ç–æ–≤–æ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É");
        log("üöÄ –û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É‚Ä¶");
        window.open(board.url, "_blank");
      } catch (err) {
        setStatus("–æ—à–∏–±–∫–∞");
        log("‚ùå –û—à–∏–±–∫–∞: " + (err && err.message ? err.message : err));
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ—Å–∫–∏: " + (err && err.message ? err.message : err));
      }
    }

    (function init() {
      const tokenFromHash = extractTokenFromHash();
      if (tokenFromHash) {
        setToken(tokenFromHash);
        scrubHash();
        log("üîê –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.");
      }

      if (getToken()) {
        createBtn.disabled = false;
        setStatus("–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –µ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥–æ—Å–∫—É");
      } else {
        createBtn.disabled = true;
        setStatus("–æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶");
      }

      authBtn.addEventListener("click", authorize);
      createBtn.addEventListener("click", createBoard);
      logoutBtn.addEventListener("click", logout);
    })();
  </script>
</body>
</html>
