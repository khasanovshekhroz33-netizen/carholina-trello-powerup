<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Carholina OneClick</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --primary:#0a4d8c; --bg:#f9fafc; }
    body { font-family: Arial, sans-serif; margin: 40px; background: var(--bg); color:#111; }
    h1 { color: var(--primary); margin-top: 0; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button {
      background: var(--primary); color: #fff; border: none;
      padding: 12px 16px; border-radius: 8px; font-size: 15px; cursor: pointer;
    }
    button.secondary { background:#e5e7eb; color:#111; }
    button:hover { filter:brightness(0.95); }
    .card {
      background:#fff; border-radius:12px; padding:18px 20px; box-shadow: 0 2px 10px rgba(0,0,0,.06);
      max-width: 780px;
    }
    .muted { color:#555; font-size:14px; }
    #log { white-space:pre-wrap; background:#0a0a0a; color:#d8ffd8; padding:12px; border-radius:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; max-height:260px; overflow:auto; }
    a { color: var(--primary); text-decoration:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Carholina OneClick Setup</h1>
    <p class="muted">
      –ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª, –∑–∞—Ç–µ–º ¬´–°–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É¬ª. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage) –∏ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–¥–µ.
    </p>

    <div class="row" style="margin:12px 0 6px;">
      <button id="authBtn">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
      <button id="createBtn" disabled>–°–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É Carholina</button>
      <button id="logoutBtn" class="secondary">–í—ã–π—Ç–∏ (—Å–±—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω)</button>
    </div>

    <p id="status" class="muted" style="margin:8px 0 14px;">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶</p>
    <div id="log" aria-live="polite"></div>

    <p class="muted" style="margin-top:16px">
      –ü–æ–¥–¥–µ—Ä–∂–∫–∞: <a href="mailto:KHASANOVSHEKHROZ33@GMAIL.COM">KHASANOVSHEKHROZ33@GMAIL.COM</a>
    </p>
  </div>

  <script>
    "use strict";

    // üîë –í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π API Key (–µ–≥–æ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–ª–∏–µ–Ω—Ç–µ)
    const API_KEY = "f0459a9c4c84226e29b03e7d047b9dfb";

    // ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∞–±–ª–æ–Ω–∞ –¥–æ—Å–∫–∏
    const BOARD_NAME = "Carholina MVP";
    const LISTS = ["To Do", "In Progress", "Done", "Features"];

    // üß≠ –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const authBtn   = document.getElementById("authBtn");
    const createBtn = document.getElementById("createBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const statusEl  = document.getElementById("status");
    const logEl     = document.getElementById("log");

    // üß∞ –£—Ç–∏–ª–∏—Ç—ã
    const log = (msg) => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };
    const setStatus = (msg) => { statusEl.textContent = "–°—Ç–∞—Ç—É—Å: " + msg; };

    // üß∑ –†–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º
    const TOKEN_KEY = "trello_token_carholina";
    const getToken  = () => localStorage.getItem(TOKEN_KEY);
    const setToken  = (t) => localStorage.setItem(TOKEN_KEY, t);
    const clearToken= () => localStorage.removeItem(TOKEN_KEY);

    // üß© –ò–∑–≤–ª–µ—á—å token –∏–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ URL (–ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
    function extractTokenFromHash() {
      if (!location.hash) return null;
      // –ü—Ä–∏–º–µ—Ä: #token=XXXXX
      const m = location.hash.match(/token=([^&]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    // üßº –£–±—Ä–∞—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–∫–æ—Å–º–µ—Ç–∏–∫–∞)
    function scrubHash() {
      if (history.replaceState) {
        history.replaceState(null, document.title, location.pathname + location.search);
      } else {
        location.hash = "";
      }
    }

    // üîê –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Trello, –∫–æ—Ç–æ—Ä–∞—è –≤–µ—Ä–Ω—ë—Ç —Ç–æ–∫–µ–Ω –Ω–∞ —ç—Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    function buildAuthorizeUrl() {
      // –í–ê–ñ–ù–û: –≤–∞—à –¥–æ–º–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ Trello ‚ûú Allowed origins
      const returnUrl = location.origin + location.pathname;
      const params = new URLSearchParams({
        expiration: "never",
        name: "CarholinaApp",
        scope: "read,write",
        response_type: "token",
        key: API_KEY,
        return_url: returnUrl
      });
      return `https://trello.com/1/authorize?${params.toString()}`;
    }

    // üîì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    function authorize() {
      const url = buildAuthorizeUrl();
      // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ —ç—Ç–æ–º –∂–µ –æ–∫–Ω–µ ‚Äî —Ç–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ –ø—Ä–æ—â–µ –ø–æ–ª—É—á–∏—Ç—å token —á–µ—Ä–µ–∑ return_url
      location.href = url;
    }

    // üßπ –í—ã—Ö–æ–¥
    function logout() {
      clearToken();
      createBtn.disabled = true;
      setStatus("—Ç–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω; –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ");
      log("‚ÑπÔ∏è –¢–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω –∏–∑ localStorage.");
    }

    // üßæ –û–±—ë—Ä—Ç–∫–∞ fetch —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    async function req(url, options) {
      const res = await fetch(url, options);
      let data = null;
      try { data = await res.json(); } catch(_) {}
      if (!res.ok) {
        const msg = data && (data.message || data.error) ? (data.message || data.error) : res.status + " " + res.statusText;
        throw new Error(msg);
      }
      return data;
    }

    // üõ† –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏ –∏ —Å–ø–∏—Å–∫–æ–≤
    async function createBoard() {
      const token = getToken();
      if (!token) {
        setStatus("–Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å");
        log("‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª.");
        return;
      }

      try {
        setStatus("—Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏‚Ä¶");
        log("‚è≥ –°–æ–∑–¥–∞—ë–º –¥–æ—Å–∫—É‚Ä¶");

        // 1) –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –¥–æ—Å–∫—É –±–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
        const createBoardUrl = `https://api.trello.com/1/boards/?name=${encodeURIComponent(BOARD_NAME)}&defaultLists=false&key=${API_KEY}&token=${token}`;
        const board = await req(createBoardUrl, { method: "POST" });
        log("‚úÖ –î–æ—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: " + (board.url || board.id));

        // 2) –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–∫–∏
        for (const listName of LISTS) {
          const createListUrl = `https://api.trello.com/1/lists?name=${encodeURIComponent(listName)}&idBoard=${board.id}&key=${API_KEY}&token=${token}`;
          await req(createListUrl, { method: "POST" });
          log("  ‚ûï –°–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω: " + listName);
        }

        setStatus("–≥–æ—Ç–æ–≤–æ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É");
        log("üöÄ –û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É‚Ä¶");
        window.open(board.url, "_blank");
      } catch (err) {
        setStatus("–æ—à–∏–±–∫–∞");
        log("‚ùå –û—à–∏–±–∫–∞: " + (err && err.message ? err.message : err));
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ—Å–∫–∏: " + (err && err.message ? err.message : err));
      }
    }

    // üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    (function init() {
      // –ï—Å–ª–∏ Trello –≤–µ—Ä–Ω—É–ª token –≤ URL-—Ö—ç—à–µ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî –∑–∞—Ö–≤–∞—Ç–∏–º –µ–≥–æ
      const tokenFromHash = extractTokenFromHash();
      if (tokenFromHash) {
        setToken(tokenFromHash);
        scrubHash();
        log("üîê –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
      }

      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
      if (getToken()) {
        createBtn.disabled = false;
        setStatus("–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –µ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ—Å–∫—É");
      } else {
        createBtn.disabled = true;
        setStatus("–æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶");
      }

      // –ù–∞–≤–µ—Å–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      authBtn.addEventListener("click", authorize);
      createBtn.addEventListener("click", createBoard);
      logoutBtn.addEventListener("click", logout);

      log("‚ÑπÔ∏è –ï—Å–ª–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ Trello ‚ûú Allowed origins –∏ –¥–æ–±–∞–≤—å—Ç–µ:");
      log("   " + location.origin);
    })();
  </script>
</body>
</html>

