<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Carholina OneClick Setup</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9fafc; }
    h1 { color: #0a4d8c; }
    button {
      background: #0a4d8c; color: white; border: none;
      padding: 12px 20px; border-radius: 6px; font-size: 16px; cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #06345d; }
    pre {
      background: #eee; padding: 10px; border-radius: 6px;
      max-height: 300px; overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>Carholina OneClick Setup</h1>
  <p>–ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª, –∑–∞—Ç–µ–º ¬´–°–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É¬ª. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage) –∏ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–¥–µ.</p>

  <button id="authBtn">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
  <button id="createBtn" disabled>–°–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É Carholina</button>
  <button id="logoutBtn">–í—ã–π—Ç–∏ (—Å–±—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω)</button>

  <p id="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶</p>
  <pre id="log">‚ÑπÔ∏è –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</pre>

  <script>
    const API_KEY = "f0459a9c4c84226e29b03e7d047b9dfb";
    const BOARD_NAME = "Carholina MVP";
    const LISTS = ["To Do", "In Progress", "Done", "Features"];

    const authBtn   = document.getElementById("authBtn");
    const createBtn = document.getElementById("createBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const statusEl  = document.getElementById("status");
    const logEl     = document.getElementById("log");

    const log = (msg) => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };
    const setStatus = (msg) => { statusEl.textContent = "–°—Ç–∞—Ç—É—Å: " + msg; };

    const TOKEN_KEY = "trello_token_carholina";
    const getToken  = () => localStorage.getItem(TOKEN_KEY);
    const setToken  = (t) => localStorage.setItem(TOKEN_KEY, t);
    const clearToken= () => localStorage.removeItem(TOKEN_KEY);

    function extractTokenFromHash() {
      if (!location.hash) return null;
      const m = location.hash.match(/token=([^&]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }
    function scrubHash() {
      if (history.replaceState) history.replaceState(null, document.title, location.pathname + location.search);
      else location.hash = "";
    }
    function buildAuthorizeUrl() {
      const returnUrl = location.origin + location.pathname;
      const params = new URLSearchParams({
        expiration: "never", name: "CarholinaApp", scope: "read,write",
        response_type: "token", key: API_KEY, return_url: returnUrl
      });
      return `https://trello.com/1/authorize?${params.toString()}`;
    }
    function authorize() { location.href = buildAuthorizeUrl(); }
    function logout() { clearToken(); createBtn.disabled = true; setStatus("—Ç–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω; –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ"); log("‚ÑπÔ∏è –¢–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω."); }

    async function req(url, options) {
      const res = await fetch(url, options);
      let data = null; try { data = await res.json(); } catch(_) {}
      if (!res.ok) throw new Error(data && (data.message || data.error) ? (data.message || data.error) : res.status + " " + res.statusText);
      return data;
    }

    async function createBoard() {
      const token = getToken();
      if (!token) { setStatus("–Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å"); log("‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞."); return; }

      try {
        setStatus("—Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏‚Ä¶");
        log("‚è≥ –°–æ–∑–¥–∞—ë–º –¥–æ—Å–∫—É‚Ä¶");
        const createBoardUrl = `https://api.trello.com/1/boards/?name=${encodeURIComponent(BOARD_NAME)}&defaultLists=false&key=${API_KEY}&token=${token}`;
        const board = await req(createBoardUrl, { method: "POST" });
        log("‚úÖ –î–æ—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: " + board.url);

        // —Å–ø–∏—Å–∫–∏
        for (const listName of LISTS) {
          await req(`https://api.trello.com/1/lists?name=${encodeURIComponent(listName)}&idBoard=${board.id}&key=${API_KEY}&token=${token}`, { method: "POST" });
          log("  ‚ûï –°–ø–∏—Å–æ–∫: " + listName);
        }

        // –º–µ—Ç–∫–∏
        const labels = [
          { name: "–í –ø—É—Ç–∏", color: "yellow" },
          { name: "–ó–∞–≤–µ—Ä—à–µ–Ω–æ", color: "green" },
          { name: "–°—Ä–æ—á–Ω–æ", color: "red" }
        ];
        for (const lbl of labels) {
          await req(`https://api.trello.com/1/labels?name=${encodeURIComponent(lbl.name)}&color=${lbl.color}&idBoard=${board.id}&key=${API_KEY}&token=${token}`, { method: "POST" });
          log("üè∑ –ú–µ—Ç–∫–∞: " + lbl.name);
        }

        // –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        const listsData = await req(`https://api.trello.com/1/boards/${board.id}/lists?key=${API_KEY}&token=${token}`);
        const members   = await req(`https://api.trello.com/1/boards/${board.id}/members?key=${API_KEY}&token=${token}`);
        const me = members[0];

        // –∫–∞—Ä—Ç–æ—á–∫–∏-—à–∞–±–ª–æ–Ω—ã
        const cards = [
          {name:"üöó –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞",list:"To Do",check:["–ü–æ–ª—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã","–ù–∞–∑–Ω–∞—á–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è","–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"]},
          {name:"üì¶ –í –ø—É—Ç–∏",list:"In Progress",label:"–í –ø—É—Ç–∏",check:["–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–∫–µ—Ä","–°–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º"]},
          {name:"‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",list:"Done",label:"–ó–∞–≤–µ—Ä—à–µ–Ω–æ",check:["–ó–∞–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑","–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç"]},
        ];

        for(const c of cards){
          const list=listsData.find(l=>l.name===c.list);
          if(!list) continue;

          let cardUrl = `https://api.trello.com/1/cards?name=${encodeURIComponent(c.name)}&idList=${list.id}&idMembers=${me.id}&key=${API_KEY}&token=${token}`;
          let newCard = await req(cardUrl, { method: "POST" });
          log("üìù –ö–∞—Ä—Ç–æ—á–∫–∞: "+c.name+" (–Ω–∞–∑–Ω–∞—á–µ–Ω: "+me.fullName+")");

          if(c.check && c.check.length){
            const checklist = await req(`https://api.trello.com/1/cards/${newCard.id}/checklists?name=–ß–µ–∫–ª–∏—Å—Ç&key=${API_KEY}&token=${token}`, { method:"POST" });
            for(const item of c.check){
              await req(`https://api.trello.com/1/checklists/${checklist.id}/checkItems?name=${encodeURIComponent(item)}&key=${API_KEY}&token=${token}`, { method:"POST" });
              log("   ‚òëÔ∏è "+item);
            }
          }
        }

        setStatus("–≥–æ—Ç–æ–≤–æ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É");
        log("üöÄ –û—Ç–∫—Ä—ã–≤–∞—é –¥–æ—Å–∫—É‚Ä¶");
        window.open(board.url, "_blank");
      } catch (err) {
        setStatus("–æ—à–∏–±–∫–∞");
        log("‚ùå –û—à–∏–±–∫–∞: " + (err && err.message ? err.message : err));
        alert("–û—à–∏–±–∫–∞: " + (err && err.message ? err.message : err));
      }
    }

    (function init() {
      const tokenFromHash = extractTokenFromHash();
      if (tokenFromHash) { setToken(tokenFromHash); scrubHash(); log("üîê –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω."); }
      if (getToken()) { createBtn.disabled = false; setStatus("–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –µ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ—Å–∫—É"); }
      else { createBtn.disabled = true; setStatus("–æ–∂–∏–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶"); }
      authBtn.addEventListener("click", authorize);
      createBtn.addEventListener("click", createBoard);
      logoutBtn.addEventListener("click", logout);
      log("‚ÑπÔ∏è –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ Trello ‚ûú Allowed origins –∏ –¥–æ–±–∞–≤—å—Ç–µ: " + location.origin);
    })();
  </script>
</body>
</html>
